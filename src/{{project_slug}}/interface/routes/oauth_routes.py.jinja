"""OAuth authentication routes."""

import logging
import time
from typing import Optional

from authlib.integrations.starlette_client import OAuthError
from fastapi import Request
import httpx
from starlette.responses import RedirectResponse

from nicegui import app

from {{ project_slug }}.infrastructure.oauth.oauth_config import (
{%- if oauth_providers in ['google', 'both'] %}
    GOOGLE_CLIENT_ID,
{%- endif %}
{%- if oauth_providers in ['twitter', 'both'] %}
    TWITTER_CLIENT_ID,
    TWITTER_CLIENT_SECRET,
{%- endif %}
    oauth,
    revoke_oauth_token,
)

{%- if oauth_providers in ['google', 'both'] %}


@app.get("/auth/google")
async def initiate_google_oauth(request: Request) -> RedirectResponse:
    """Initiate Google OAuth flow."""
    return await oauth.google.authorize_redirect(
        request, request.url_for("google_oauth"), prompt="select_account"
    )


@app.get("/auth/google/callback")
async def google_oauth(request: Request) -> RedirectResponse:
    """Callback: exchange code for token and store user info."""
    token = await oauth.google.authorize_access_token(request)
    userinfo = token.get("userinfo") or await oauth.google.parse_id_token(
        request, token
    )
    app.storage.user["user_info"] = userinfo
    app.storage.user["oauth_token"] = token
    app.storage.user["oauth_provider"] = "google"
    return RedirectResponse("/")
{%- endif %}

{%- if oauth_providers in ['twitter', 'both'] %}


@app.get("/auth/twitter")
async def initiate_twitter_oauth(request: Request) -> RedirectResponse:
    """Initiate Twitter OAuth flow."""
    return await oauth.twitter.authorize_redirect(
        request, request.url_for("twitter_oauth")
    )


@app.get("/auth/twitter/callback")
async def twitter_oauth(request: Request) -> RedirectResponse:
    """Callback: exchange code for token and store user info."""
    try:
        token = await oauth.twitter.authorize_access_token(request)
        # Fetch user info from Twitter API
        async with httpx.AsyncClient() as client:
            resp = await client.get(
                "https://api.twitter.com/2/users/me",
                headers={"Authorization": f'Bearer {token["access_token"]}'},
                params={"user.fields": "id,name,username"},
            )
            twitter_user = resp.json().get("data", {})

        # Store user info in a format compatible with validation
        userinfo = {
            "name": twitter_user.get("name"),
            "email": twitter_user.get("username", "") + "@twitter.com",
            "sub": twitter_user.get("id"),
            "exp": int(time.time()) + 3600,  # 1 hour expiration
            "aud": TWITTER_CLIENT_ID,
            "iss": "twitter.com",
            "email_verified": "true",
        }

        app.storage.user["user_info"] = userinfo
        app.storage.user["oauth_token"] = token
        app.storage.user["oauth_provider"] = "twitter"
    except (OAuthError, Exception):
        logging.exception("could not authorize Twitter access token")

    return RedirectResponse("/")
{%- endif %}


@app.get("/logout")
async def logout(request: Request) -> RedirectResponse:
    """Log out locally by clearing user session info and revoking token."""
    token = app.storage.user.pop("oauth_token", None)
    oauth_provider = app.storage.user.pop("oauth_provider", None)
    app.storage.user.pop("user_info", None)

    # Try to revoke token (best-effort)
    if token:
        await revoke_oauth_token(token, oauth_provider)

    # Redirect back to the login page
    return RedirectResponse("/login")

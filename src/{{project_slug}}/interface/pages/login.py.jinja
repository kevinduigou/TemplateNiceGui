"""Login page for OAuth authentication."""

from fastapi import Request
from nicegui import app, ui
from starlette.responses import RedirectResponse

from {{ project_slug }}.infrastructure.oauth.oauth_config import validate_user_info
{%- if use_rq_worker and use_sqlite_db %}
from {{ project_slug }}.infrastructure.cache_db.db_repository import DBRepository
from {{ project_slug }}.infrastructure.rq_client import RQClient
from {{ project_slug }}.interface.components.job_monitor_component import JobMonitorComponent
{%- endif %}


@ui.page("/login")
async def login_page(request: Request) -> None:
    """Login page where users can choose their authentication method."""
    with ui.column().classes("absolute-center items-center"):
        ui.label("Welcome! Please choose how to authenticate:").classes(
            "text-h4 q-mb-md"
        )

        with ui.card().classes("q-pa-lg"):
{%- if oauth_providers in ['google', 'both'] %}
            ui.button(
                "Sign in with Google",
                icon="login",
                on_click=lambda: ui.navigate.to("/auth/google"),
            ).props("color=primary size=lg").classes("q-mb-md")
{%- endif %}

{%- if oauth_providers in ['twitter', 'both'] %}
            ui.button(
                "Sign in with Twitter",
                icon="login",
                on_click=lambda: ui.navigate.to("/auth/twitter"),
            ).props("color=info size=lg").classes("q-mb-md")
{%- endif %}


@ui.page("/")
async def main_page(request: Request) -> RedirectResponse | None:
    """Main page - redirects to login if not authenticated."""
    user_info = app.storage.user.get("user_info", {})
    if not validate_user_info(user_info):
        app.storage.user.pop("user_info", None)
        return RedirectResponse("/login")

    oauth_provider = app.storage.user.get("oauth_provider")

    with ui.column().classes("w-full q-pa-md"):
        ui.label(f"Welcome {user_info.get('name') or user_info.get('email', '')}!").classes(
            "text-h4"
        )
        ui.label(f"Email: {user_info.get('email', '')}")

        with ui.row().classes("q-mt-md q-mb-lg"):
            ui.button("Logout", on_click=lambda: ui.navigate.to("/logout"))
{%- if oauth_providers in ['twitter', 'both'] %}
            if oauth_provider == "twitter":
                ui.button("View My Tweets", on_click=lambda: ui.navigate.to("/tweets")).props(
                    "color=info"
                )
{%- endif %}

{%- if use_rq_worker and use_sqlite_db %}

        # Add Job Monitor Component
        ui.separator().classes("q-my-lg")
        ui.label("Async Job Management").classes("text-h5 q-mb-md")

        # Initialize dependencies
        db_repository = DBRepository()
        rq_client = RQClient()

        # Create and render the job monitor component
        job_monitor = JobMonitorComponent(
            rq_client=rq_client,
            db_repository=db_repository,
        )

        monitor_container = ui.column().classes("w-full")
        job_monitor.render(monitor_container)
{%- endif %}

    return None

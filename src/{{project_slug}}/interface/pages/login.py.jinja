"""Login page for OAuth authentication."""

from typing import Optional

from fastapi import Request
from starlette.responses import RedirectResponse

from nicegui import app, ui

from {{ project_slug }}.infrastructure.oauth.oauth_config import validate_user_info


@ui.page("/login")
async def login_page(request: Request) -> None:
    """Login page where users can choose their authentication method."""
    with ui.column().classes("absolute-center items-center"):
        ui.label("Welcome! Please choose how to authenticate:").classes(
            "text-h4 q-mb-md"
        )

        with ui.card().classes("q-pa-lg"):
{%- if oauth_providers in ['google', 'both'] %}
            ui.button(
                "Sign in with Google",
                icon="login",
                on_click=lambda: ui.navigate.to("/auth/google"),
            ).props("color=primary size=lg").classes("q-mb-md")
{%- endif %}

{%- if oauth_providers in ['twitter', 'both'] %}
            ui.button(
                "Sign in with Twitter",
                icon="login",
                on_click=lambda: ui.navigate.to("/auth/twitter"),
            ).props("color=info size=lg").classes("q-mb-md")
{%- endif %}


@ui.page("/")
async def main_page(request: Request) -> Optional[RedirectResponse]:
    """Main page - redirects to login if not authenticated."""
    user_info = app.storage.user.get("user_info", {})
    if not validate_user_info(user_info):
        app.storage.user.pop("user_info", None)
        return RedirectResponse("/login")

    oauth_provider = app.storage.user.get("oauth_provider")

    ui.label(
        f'Welcome {user_info.get("name") or user_info.get("email", "")}!'
    ).classes("text-h4")
    ui.label(f'Email: {user_info.get("email", "")}')

    with ui.row().classes("q-mt-md"):
        ui.button("Logout", on_click=lambda: ui.navigate.to("/logout"))
{%- if oauth_providers in ['twitter', 'both'] %}
        if oauth_provider == "twitter":
            ui.button(
                "View My Tweets", on_click=lambda: ui.navigate.to("/tweets")
            ).props("color=info")
{%- endif %}

{%- if use_rq_worker and use_sqlite_db %}

    ui.separator().classes("q-my-lg")

    # Job Monitor Section
    import os
    from {{ project_slug }}.infrastructure.rq_client import RQClient
    from {{ project_slug }}.infrastructure.cache_db import DBRepository
    from {{ project_slug }}.interface.components.job_monitor_component import JobMonitorComponent

    with ui.column().classes("w-full max-w-4xl"):
        # Initialize infrastructure dependencies
        redis_url = os.getenv("REDIS_URL", "redis://localhost:6379")
        db_url = os.getenv("DATABASE_URL", "sqlite:///data/{{ project_slug }}.db")

        rq_client = RQClient(redis_url=redis_url)
        db_repository = DBRepository(db_url=db_url)

        # Create and render job monitor component
        job_monitor = JobMonitorComponent(
            rq_client=rq_client,
            db_repository=db_repository,
        )
        job_monitor.render(ui.column().classes("w-full"))
{%- endif %}

    return None

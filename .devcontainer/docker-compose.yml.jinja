# Inspired by https://github.com/microsoft/vscode-dev-containers/blob/main/container-templates/docker-compose/.devcontainer/docker-compose.yml
services:
  devcontainer:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
      args:
        USERNAME: ${USER}

    volumes:
      - ..:/workspaces/{{ project_slug }}

    # Overrides default command so things don't shut down after the process ends.
    command: sleep infinity

    # Runs app on the same network as the Redis container
{%- if async_task_backend == 'redis_rq' %}
    depends_on:
      - redis

    environment:
      - REDIS_URL=redis://redis:6379/0
{%- endif %}

    # ! Use "forwardPorts" in **devcontainer.json** to forward an app port locally.
    # (Adding the "ports" property to this file will not forward from a Codespace.)

    # Uncomment the next line to use a non-root user for all processes - See https://aka.ms/vscode-remote/containers/non-root for details.
    # user: vscode

    # Uncomment the next four lines if you will use a ptrace-based debugger like C++, Go, and Rust.
    # cap_add:
    #   - SYS_PTRACE
    # security_opt:
    #   - seccomp:unconfined

{%- if async_task_backend == 'redis_rq' %}

  # Redis service for RQ (Redis Queue)
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
{%- endif %}

{%- if async_task_backend == 'redis_rq' %}

volumes:
  redis-data:
{%- endif %}
